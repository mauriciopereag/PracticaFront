name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build with custom script
      run: |
        cat <<EOT > build-ci.js
        const { execSync } = require('child_process');
        const fs = require('fs');
        
        // Polyfill para crypto
        if (typeof global.crypto === 'undefined') {
          global.crypto = {};
        }
        
        if (typeof global.crypto.getRandomValues === 'undefined') {
          global.crypto.getRandomValues = function(array) {
            for (let i = 0; i < array.length; i++) {
              array[i] = Math.floor(Math.random() * 256);
            }
            return array;
          };
        }
        
        // Ejecuta el build
        execSync('npx vite build', { stdio: 'inherit' });
        
        // Crea el archivo .nojekyll
        fs.writeFileSync('dist/.nojekyll', '');
        EOT
        
        node build-ci.js
    
    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        branch: gh-pages
        folder: dist
    
    # Agregar pasos adicionales para despliegue si es necesario 